---
- hosts: all
  become: true
  tasks:
  - name: Adding apt repository for InfluxDB
    apt_repository:
      repo: deb https://repos.influxdata.com/ubuntu bionic stable
      state: present
      filename: influxdb.list
  - name: Add repo-key to the host
    shell: sudo curl -sL https://repos.influxdata.com/influxdb.key | sudo apt-key add -
  - name: Install InfluxDB binaries
    apt: 
      name: "{{ packages }}"
      state: present
      update_cache: yes
    vars:
      packages:
        - influxdb
  - name: Copy the join command to server location
    copy: 
      src: influxDB/influxdb.conf 
      dest: /etc/influxdb/influxdb.conf
      owner: root
      group: root
      mode: 0777
  - name: Restart InfluxDB
    service:
      name: influxdb
      daemon_reload: yes
      enabled: yes
      state: restarted
  - name: Create the admin account of the influxDB
    local_action: curl -XPOST "http://192.168.50.8:8086/query" --data-urlencode "q=CREATE USER superadmin WITH PASSWORD 'vagrant1234' WITH ALL PRIVILEGES"